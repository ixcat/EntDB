.. $Id$

=====
entdb
=====

Overview
--------

entdb is a simple CLI/SQLite3 based datastore to support user account
metadata, presently primarily targeting a basic single-domain
user/group/netgroup/autofs NIS/Lan scenario.

Currently included:

  - support for loading/dumping of standard flat file format for:

    - v7 style /etc/passwd with shadowed password hash
    - v7 style /etc/group
    - SysV? & GNU/Linux style /etc/shadow
    - 4.3BSD style passwd (/etc/master.passwd on modern BSD-derived systems)
    - SunOS 4.x style /etc/netgroup
    - SunOS 4.x style /etc/passwd.adjunct file
    - Sendmail/4.3BSD /etc/mail/aliases file

  - generic regexp-based key:value loading/dumping (1:1 and 1:M)

Installation
------------

Typical perl install::

  $ perl Makefile.PL
  $ make
  # make install

Some prerequisite modules are required:

  - DBD::SQLite
  - Crypt::PasswdMD5
  - Crypt::Eksblowfish

On RHEL::

  # yum localinstall \
  https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
  # yum --enablerepo=epel install perl-Crypt-PasswdMD5 \
  perl-Crypt-Eksblowfish perl-DBD-SQLite perl-ExtUtils-MakeMaker

To install a database and makefile to manage entdb generated flatfiles::

  $ make -f doc/entdb.mk installdb

This will install into /var/yp/ent by default; this location can
be customized by setting the variable ENTDIR accordingly.

If your aliases(5) file is not /etc/mail/aliases, you should set
the variable SRCALIASES to point to your systems' location. The
installdb target also requires the presence of a netgroup(5) file -
creating an empty file in /etc/netgroup should suffice if one is
not in local use.

The resulting installation will contain an entdb database in the
file ${ENTDIR}/db, which contains the available system users,
passwords, groups, netgroup entries, and mail aliases. The entdb.mk
makefile is also copied into place and has several useful targets
for maintiaining the flat files which can be generated by the entdb
script. Simply running 'make' in this directory should yield appropriate
help information, however, the key targets are 'files', which generates
all related flatfiles, and ypupdate, which will triger a 'make' from
within the configured YPDIR.

Specifically, the entdb makefile *does not* directly update 
the related NIS maps - it is expected that users configure their
system's YP makefile to point to the entdb location to reference
the entdb generated files as is locally applicable.

Server NIS Configuration
------------------------

TBD in depth - install linux.mk or obsd.mk as is appropriate
to generate maps from /var/yp/ent files:

  # cp doc/linux.mk /var/yp/Makefile
  # cp doc/obsd.mk /var/yp/`domainname`/Makefile

Client NIS Configuration
------------------------

This section will be expanded with more cohesive setup docs, for now,
it contains some notes on configuring NIS lookups after yp has been enabled
as a client.

Linux
~~~~~

Pam files should contain:

  password    sufficient    pam_unix.so md5 shadow nis nullok try_first_pass use_authtok

without the 'local account only' section.

/etc/nsswitch.conf should contain:

passwd:     compat
shadow:     compat
group:      files nis
netgroup:   files nis
aliases:    files nis

/etc/passwd & /etc/shadow:

passwd should get all data (for e.g. uid lookups):

  # tail -n 1 /etc/passwd
  +

for all users allowed, allow all shadow records:

  # tail -n 1 /etc/shadow
  +::0:0:0::::

for a certain netgroup allowed, allow only the group and block rest

  # tail -n 2 /etc/shadow
  +@foo::::::
  +:*:::::/sbin/nologin

OpenBSD
~~~~~~~

Enable NIS via master.passwd:

  # tail -n 1 /etc/master.passwd
  +:*::::::::

Solaris
~~~~~~~

For all users:

tail -n 1 /etc/passwd
+::::::

For netgroup only:

tail -n 1 /etc/passwd
+@foo::::::
+:*:::::/sbin/nologin

